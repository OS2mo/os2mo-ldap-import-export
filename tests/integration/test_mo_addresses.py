# SPDX-FileCopyrightText: Magenta ApS <https://magenta.dk>
# SPDX-License-Identifier: MPL-2.0

from datetime import datetime
from uuid import UUID

import pytest

from mo_ldap_import_export.autogenerated_graphql_client.addresses import (
    AddressesAddresses,
)
from mo_ldap_import_export.autogenerated_graphql_client.addresses import (
    AddressesAddressesObjects,
)
from mo_ldap_import_export.autogenerated_graphql_client.addresses import (
    AddressesAddressesObjectsCurrent,
)
from mo_ldap_import_export.autogenerated_graphql_client.input_types import (
    AddressCreateInput,
)
from mo_ldap_import_export.autogenerated_graphql_client.input_types import (
    ITUserCreateInput,
)
from mo_ldap_import_export.autogenerated_graphql_client.input_types import (
    RAValidityInput,
)
from mo_ldap_import_export.depends import GraphQLClient
from mo_ldap_import_export.environments.main import mo_addresses


@pytest.mark.integration_test
@pytest.mark.usefixtures("test_client")
async def test_mo_addresses(
    graphql_client: GraphQLClient,
    adtitle: UUID,
    mo_person: UUID,
    email_employee: UUID,
) -> None:
    ituser = await graphql_client.ituser_create(
        input=ITUserCreateInput(
            itsystem=adtitle,
            user_key="foo",
            person=mo_person,
            external_id="bar",
            validity=RAValidityInput(
                from_=datetime(2020, 1, 1),
                to=None,
            ),
        ),
    )
    address = await graphql_client.address_create(
        input=AddressCreateInput(
            person=mo_person,
            user_key="foo",
            value="foo@example.org",
            address_type=email_employee,
            ituser=ituser.uuid,
            validity=RAValidityInput(
                from_=datetime(2020, 1, 1),
                to=None,
            ),
        ),
    )
    result = await mo_addresses(
        graphql_client,
        filter={
            "user_key": "foo",
        },
    )
    assert result == AddressesAddresses(
        objects=[
            AddressesAddressesObjects(
                uuid=address.uuid,
                current=AddressesAddressesObjectsCurrent(
                    ituser_uuid=ituser.uuid,
                ),
            )
        ]
    )
